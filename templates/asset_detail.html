{% extends "base.html" %}

{% block title %}{{ asset.symbol }} - StockFolio{% endblock %}

{% block content %}
<div class="asset-detail-container">
    <a href="/dashboard" class="back-link">&larr; Back to Dashboard</a>

    <!-- Asset Header -->
    <div class="asset-header">
        <div class="asset-header-info">
            <h1>
                <span class="asset-detail-symbol">{{ asset.symbol }}</span>
                <span class="asset-detail-name">{{ asset.name }}</span>
            </h1>
            <div class="asset-meta">
                <span class="asset-exchange-badge">{{ asset.exchange }}</span>
                <span class="asset-type-badge">{{ asset.asset_type }}</span>
            </div>
        </div>
        <div class="asset-header-price">
            <div class="current-price-large">${{ "%.2f"|format(current_price) }}</div>
            <div class="price-change {{ 'gain' if stock_info.change_percent >= 0 else 'loss' }}">
                {{ "+" if stock_info.change_percent >= 0 else "" }}{{ "%.2f"|format(stock_info.change_percent) }}% today
            </div>
        </div>
        <button class="btn btn-danger btn-small" onclick="deleteAsset('{{ asset.id }}', '{{ asset.symbol }}')">
            Delete Asset
        </button>
    </div>

    <!-- Summary -->
    <div class="asset-summary">
        <div class="summary-card">
            <span class="summary-label">Total Paid</span>
            <span class="summary-value">${{ "%.2f"|format(total_paid) }}</span>
        </div>
        <div class="summary-card">
            <span class="summary-label">Current Value</span>
            <span class="summary-value">${{ "%.2f"|format(total_value) }}</span>
        </div>
        <div class="summary-card">
            <span class="summary-label">Total Profit/Loss</span>
            <span class="summary-value {{ 'gain' if is_gain else 'loss' }}">
                {{ "+" if is_gain else "" }}${{ "%.2f"|format(total_profit) }}
            </span>
        </div>
        <div class="summary-card">
            <span class="summary-label">Profit / Month</span>
            {% if profit_per_month is not none %}
            <span class="summary-value {{ 'gain' if profit_per_month >= 0 else 'loss' }}">
                {{ "+" if profit_per_month >= 0 else "" }}${{ "%.2f"|format(profit_per_month) }}
            </span>
            {% else %}
            <span class="summary-value" style="color:#94a3b8;">—</span>
            {% endif %}
        </div>
        <div class="summary-card">
            <span class="summary-label">Profit / Year</span>
            {% if profit_per_year is not none %}
            <span class="summary-value {{ 'gain' if profit_per_year >= 0 else 'loss' }}">
                {{ "+" if profit_per_year >= 0 else "" }}${{ "%.2f"|format(profit_per_year) }}
            </span>
            {% else %}
            <span class="summary-value" style="color:#94a3b8;">—</span>
            {% endif %}
        </div>
        <div class="summary-card">
            <span class="summary-label">Status</span>
            <span class="summary-value {{ 'gain' if is_gain else 'loss' }}">
                {{ "Gaining" if is_gain else "Losing" }}
            </span>
        </div>
    </div>

    <!-- Analyst Info -->
    {% if recommendation_key or target_mean_price %}
    <div class="analyst-info-row">
        <div class="summary-card">
            <span class="summary-label">Analyst Recommendation</span>
            <span class="summary-value">
                {% if recommendation_key == 'strong_buy' %}
                    <span class="analyst-badge analyst-strong-buy">Strong Buy</span>
                {% elif recommendation_key == 'buy' %}
                    <span class="analyst-badge analyst-buy">Buy</span>
                {% elif recommendation_key == 'hold' %}
                    <span class="analyst-badge analyst-hold">Hold</span>
                {% elif recommendation_key in ('underperform', 'sell') %}
                    <span class="analyst-badge analyst-sell">Sell</span>
                {% else %}
                    <span style="color:#94a3b8;">—</span>
                {% endif %}
            </span>
        </div>
        <div class="summary-card">
            <span class="summary-label">Analyst Target Price</span>
            <span class="summary-value">
                {% if target_mean_price %}
                    ${{ "%.2f"|format(target_mean_price) }}
                {% else %}
                    <span style="color:#94a3b8;">—</span>
                {% endif %}
            </span>
        </div>
        <div class="summary-card">
            <span class="summary-label">Number of Analysts</span>
            <span class="summary-value">
                {% if number_of_analyst_opinions %}
                    {{ number_of_analyst_opinions }}
                {% else %}
                    <span style="color:#94a3b8;">—</span>
                {% endif %}
            </span>
        </div>
    </div>
    {% endif %}

    <!-- Add Purchase Form -->
    <div class="add-purchase-section">
        <h2>Add Purchase</h2>
        <form id="addPurchaseForm" class="purchase-form" data-asset-id="{{ asset.id }}">
            <div class="form-row">
                <div class="form-group">
                    <label for="purchaseDate">Date</label>
                    <input type="date" id="purchaseDate" name="purchase_date" required>
                </div>
                <div class="form-group">
                    <label for="purchasePrice">Price per Unit ($)</label>
                    <input type="number" id="purchasePrice" name="price_per_unit"
                           step="0.01" min="0.01" placeholder="0.00" required>
                </div>
                <div class="form-group">
                    <label for="purchaseQuantity">Quantity</label>
                    <input type="number" id="purchaseQuantity" name="quantity"
                           min="1" placeholder="0" required>
                </div>
                <div class="form-group">
                    <label for="purchaseNotes">Notes</label>
                    <input type="text" id="purchaseNotes" name="notes"
                           placeholder="Optional notes">
                </div>
                <div class="form-group form-group-btn">
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </div>
            <div id="addPurchaseError" class="form-error" style="display: none;"></div>
        </form>
    </div>

    <!-- Purchase History -->
    <div class="purchase-history">
        <h2>Purchase History</h2>
        {% if purchases %}
        <div class="table-container">
            <table class="purchases-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Price/Unit</th>
                        <th>Quantity</th>
                        <th>Total Cost</th>
                        <th>Current Value</th>
                        <th>Profit/Loss</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in purchases %}
                    <tr>
                        <td>{{ p.purchase_date }}</td>
                        <td>${{ "%.2f"|format(p.price_per_unit) }}</td>
                        <td>{{ p.quantity }}</td>
                        <td>${{ "%.2f"|format(p.total_cost) }}</td>
                        <td>${{ "%.2f"|format(p.current_value) }}</td>
                        <td class="{{ 'gain' if p.is_gain else 'loss' }}">
                            {{ "+" if p.is_gain else "" }}${{ "%.2f"|format(p.profit) }}
                        </td>
                        <td>
                            <button class="btn btn-danger btn-small"
                                    onclick="deletePurchase('{{ asset.id }}', '{{ p.id }}')">
                                Delete
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state empty-state-small">
            <p>No purchases yet. Add your first purchase above.</p>
        </div>
        {% endif %}
    </div>

    <!-- TradingView Chart & open link -->
    <div class="tradingview-section tradingview-section-bottom">
        <h2>Chart &amp; Analysis</h2>
        <p class="tradingview-attribution">Charts and data by <a href="https://www.tradingview.com/" target="_blank" rel="noopener">TradingView</a></p>
        <div class="tradingview-chart-container">
            <div class="tradingview-widget-container tradingview-widget-container--large">
                <div class="tradingview-widget-container__widget"></div>
                <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js" async>
                {
                    "autosize": true,
                    "width": "100%",
                    "height": "100%",
                    "symbol": "{{ tv_symbol }}",
                    "interval": "D",
                    "timezone": "Etc/UTC",
                    "theme": "light",
                    "style": "1",
                    "locale": "en",
                    "allow_symbol_change": true,
                    "calendar": false,
                    "support_host": "https://www.tradingview.com"
                }
                </script>
            </div>
        </div>
        <a href="https://www.tradingview.com/symbols/{{ tv_symbol|replace(':', '-') }}/" target="_blank" rel="noopener noreferrer" class="tradingview-open-link">
            <span class="tradingview-open-icon">&#x1F4C8;</span>
            Open {{ asset.symbol }} on TradingView (full view)
        </a>
    </div>
</div>
{% endblock %}
